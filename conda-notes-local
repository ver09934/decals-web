Attempting to get the viewer running in a Debian VM.

Base setup
----------
Debian 10 netinstall w/ xfce
sudo apt install vim htop tree git tmux locate gcc make perl dkms linux-headers-4.19.0-5-all
cd && git clone https://github.com/ver09934/decals-web.git

Conda setup
-----------
Install anaconda3 to ~/anaconda3
conda create --name decals-web python=3
Installer runs "conda init" to put conda activation in .bashrc
Add "conda activate decals-web" to .bashrc
Update conda: "conda update -n base -c defaults conda"
To create a backup environment at any time: conda create --name decals-web-clone --clone decals-web
To remove the old backup: conda env remove --name decals-web-clone

Install dependencies in Conda env
---------------------------------
pip install django
pip install numpy
pip install scipy
pip install matplotlib
# pip install fitsio
pip install psycopg2 --> need "sudo apt install libpq-dev"
pip install astropy
pip install pillow
# pip install uwsgi --> need "sudo apt install libssl-dev", still fails
conda config --append channels conda-forge && conda install uwsgi
conda install swig 

pip install --no-deps --upgrade git+https://github.com/esheldon/fitsio.git#egg=fitsio

cd ~/Downloads
# check that conda prefix is set: echo $CONDA_PREFIX
wget ftp://ftp.atnf.csiro.au/pub/software/wcslib/wcslib.tar.bz2
tar xjf wcslib.tar.bz2
mv wcslib-* wcslib && cd wcslib
./configure --prefix=$CONDA_PREFIX
make
make install
cd ..

# See http://astrometry.net/doc/build.html for build info

export PKG_CONFIG_PATH=$CONDA_PREFIX/lib/pkgconfig

# Install astrometry.net dependencies:
# (python-pyfits --> astropy-utils)
sudo apt install libcairo2-dev libnetpbm10-dev netpbm libpng-dev libjpeg-dev python-numpy astropy-utils python-dev zlib1g-dev libbz2-dev swig libcfitsio-dev

cd ~/Downloads
git clone https://github.com/dstndstn/astrometry.net.git   
cd astrometry.net
make -k
make -k py
make -k extra
make install INSTALL_DIR=$CONDA_PREFIX
python setup.py install --prefix=$CONDA_PREFIX
cd ..

# See https://github.com/dstndstn/tractor for build info
# TODO: Needs numpy >= 1.4, but conda is ~1.16?
conda install cython # seems like tractor might need it?
conda install emcee
conda install matplotlib
cd ~/Downloads
git clone https://github.com/dstndstn/tractor.git 
cd tractor
make && make all
python setup.py install --prefix=$CONDA_PREFIX

# Not really sure what's happening with this one...
cd ~/Downloads
git clone https://github.com/legacysurvey/legacypipe.git
make && make all && make install INSTALL_DIR=$CONDA_PREFIX WORKING_DIR=~/Downloads/legacypipe # Not sure this did anything much...
python setup.py install --prefix=$CONDA_PREFIX

cd ~/decals-web/viewer
cp settings_test.py settings.py
cd ..
python3 manage.py runserver
... some other random file changes later ...
It runs! Kind of...

cd ~/anaconda3/envs/decals-web/lib/python3.7/site-packages/astrometry/catalogs
ln -s ~/Downloads/astrometry.net/catalogs/ngc2000.fits ngc2000.fits
ln -s ~/Downloads/astrometry.net/catalogs/ic2000.fits ic2000.fits

What seems to be happening...
-----------------------------
- If you give the VM an internet connection, the viewer runs (mostly) fine (obviously missing some files, etc.)
    - It appears to be using the legacysurvey.org pre-rendered tiles and cutout server
- If you don't give the VM an internet connection, the viewer loads, but no images loads
    - Using "httpry", seems like the viewer is still attempting to query legacysurvey.org
    - Probably just some settings problem w/ domain names, using "legacysurvey.org" instead of "localhost" somewhere
- However, if one queries the local cutout server, it looks locally (in data/) for the coadd files

To get the cutout server running
--------------------------------
- Create a cutout server test URL, something like this:
    - http://localhost:8000/jpeg-cutout?ra=228.3771&dec=5.4232&zoom=14&layer=decals-dr7
    - With the dnango server running, request the image using a web browser
- Watch the django output, it will look something like this:

get_layer: name "decals-dr7"
get_layer: decals-dr7 -- generic
Survey name decals-dr7
layer: <map.views.ReDecalsLayer object at 0x7fcc5089ee48>
Request has zoom= 14 : setting pixscale= 0.262
RA,Dec bounds of WCS: 228.36777911047557 228.38642088952446 5.413920833413364 5.432479166584441
checking for cache fn /home/ian/decals-web/data/decals-dr7/extra-images/survey-bricks.fits.gz
Bricks touching RA,Dec box 228.36777911047557 228.38642088952446 Dec 5.413920833413364 5.432479166584441 scale 0 :  2283p055
Reading 2283p055 band g scale 0
checking for cache fn /home/ian/decals-web/data/decals-dr7/extra-images/coadd/228/2283p055/legacysurvey-2283p055-image-g.fits.fz
Reading 2283p055 band g scale 0 -> fn /home/ian/decals-web/data/decals-dr7/coadd/228/2283p055/legacysurvey-2283p055-image-g.fits.fz
Reading image from /home/ian/decals-web/data/decals-dr7/coadd/228/2283p055/legacysurvey-2283p055-image-g.fits.fz
Reading 2283p055 band r scale 0
checking for cache fn /home/ian/decals-web/data/decals-dr7/extra-images/coadd/228/2283p055/legacysurvey-2283p055-image-r.fits.fz
Reading 2283p055 band r scale 0 -> fn /home/ian/decals-web/data/decals-dr7/coadd/228/2283p055/legacysurvey-2283p055-image-r.fits.fz
Reading image from /home/ian/decals-web/data/decals-dr7/coadd/228/2283p055/legacysurvey-2283p055-image-r.fits.fz
Reading 2283p055 band z scale 0
checking for cache fn /home/ian/decals-web/data/decals-dr7/extra-images/coadd/228/2283p055/legacysurvey-2283p055-image-z.fits.fz
Reading 2283p055 band z scale 0 -> fn /home/ian/decals-web/data/decals-dr7/coadd/228/2283p055/legacysurvey-2283p055-image-z.fits.fz
Reading image from /home/ian/decals-web/data/decals-dr7/coadd/228/2283p055/legacysurvey-2283p055-image-z.fits.fz
[10/Jul/2019 15:04:09] "GET /jpeg-cutout?ra=228.3771&dec=5.4232&zoom=14&layer=decals-dr7 HTTP/1.1" 200 21251

- Get the files it is looking for from https://portal.nersc.gov/project/cosmo/data/legacysurvey/dr7/
- Put the files in the path that django is looking for...
- A cutout jpeg image should be generated and displayed in the browser
